# LiunuxOS

liunuxos包含两个工程，liunuxos和liunuxos_c。liunuxos是基于masm的汇编代码，liunuxos_c是基于vs的c、c++代码。

编译方法：

1.利用masm生成mb.com, loader.com, liunuxos.exe。

切换到linuxos目录，在windows xp、windows 7 32位command/cmd执行：

masm mbr;

link mbr;

exe2bin mbr.exe mbr.com

上述3条命令生成mbr.com

masm loader;

link loader;

exe2bin loader.exe loader.com

上述3条命令生成loader.com

masm kernel;

link kernel;

上述2条命令生成kernel.exe

2. visual studio下编译生成kernel.dll、main.dll、liunuxsetup.exe。注意要关闭代码优化、GS、c++异常等编译选项。
3. 将kernel.dll、main.dll、liunuxsetup.exe、mbr.com、loader.com，kernel.exe等文件放在c盘下，比如新建一个liunux文件下，目录为c:\liunux，在windows/linux系统中打开文件夹，并执行liunuxset.exe，即可将系统安装到当前系统中，重启后会进入liunuxos。
   



liunuxos主要功能：

 1. 进程线程创建和调度。8254时钟计时器每过一个计时周期就会触发一次中断，这就是liunuxos的线程/进程调度周期，大概为10ms。

	当前支持两种进程/线程切换方式。第一种只需要一个tss任务状态段。进入时钟中断后，中断程序保存旧的线程/进程的硬件寄存器等执行现场环境，具体实现细节是：将当前旧线程的寄存器按顺序push到中断的堆栈中，并保存到一个全局地址中，然后查找新的调度线程，并将新线程的硬件寄存器和其他现场寄存器替换当前内核堆栈中旧线程的寄存器，当执行iret指令后，新的寄存器和现场环境被弹出到新线程中，并开始执行新的线程。

	第二种线程切换需要两个tss，其中一个所有进程共用，另外一个是任务门。时钟中断被当作一个任务门的任务，每当中断发生时，进程的硬件寄存器被自动保存在所有进程共享的那个tss中，在中断程序中，将该tss内容以及其他任务变量值拷贝到该进程的信息表中（进程信息表基地址在系统启动时被设置为全局地址，通过pid可以找到进程的所有信息，包括通用寄存器、段寄存器、浮点寄存器、调试寄存器、其他进程信息等），然后把要被调度执行的进程的tss数据复制到所有任务共享的tss中，中断程序执行iret指令返回后，新的线程被启动运行。进程调度使用比较简单的轮转调度。
	应用进程的栈初始化大小是1MB，系统进程的栈初始化大小是64kb。

	进程是资源的载体，进程创建的每个线程都是单独调度的，只在进程切换时修改cr3，而进程内部线程之间的任务切换并不修改cr3，代码利用pid判断线程是否位于同一个进程。
	
	该模块支持通用的进程创建、加载、切换，支持任意的标准pe文件加载执行。
	
	liunuxos不支持apic模式，虽然是多进程多线程，但只使用一个cpu。

 2. 文件系统读写。主要包括ntfs、fat32、iso9660、fat16、floppy等文件系统的读取操作。文件系统的资料网上很多，请自行百度。硬盘驱动器在虚拟机创建时只能支持ATA和SATA模式。
 3. 基于文件系统的文件浏览器。支持打开文本文件和加载可执行程序。
 4. 支持dos下的16位程序的加载执行。
 
 5. 内存管理。主要是内存分配和虚拟内存的实现。关于虚拟内存，网上资料很多，但是没有找到切实可行的方法。我的做法分为两步：							 
首先，在kernel.exe进入保护模式时，开启分页，具体的分页策略是：物理地址和线性地址一一对应的关系。第二步，在进程创建时，复制全局的页目录表，但只包括系统空间的部分页表，其他页表设置为0，同时调用全局的内存分配程序（采用slab算法，分配的是物理地址而不是线性地址），分配的内存大小页面对齐，然后修改进程的页表项，并将其映射为从1gb依次往高地址的递增的虚拟线性地址。
此种分页下，系统进程的线性地址都是物理地址，并且可以被每个用户进程访问，但是应用程序的代码段、数据段、堆栈段地址都是线性递增的，可以实现用户进程空间的隔离。

	liunuxos虽然支持虚拟内存，但是不支持内存交换等功能。

	liunuxos具体的内存地址分布可以查看def.h文件。

 6. 键盘鼠标功能。支持键盘输入，CTRL、CAPSLOCK、shift等控制按键。鼠标控制以及左右键点击等操作，进而支持右键菜单。
 7. 汉字和英文字母的图形化显示。英文字母利用bios区域的8x8点阵字体，汉字使用8x16点阵字体显示。支持窗口字体显示和管理。
 
 8. soundblaster声卡播放wav格式音乐。虚拟机创建时必须指定声卡为soundblaster型。
 9. 提供int80h作为系统API调用入口，提供一些较为简单的API接口，比如，结合进程调度实现的休眠函数sleep，其他的开发接口。

 10. x86断点，单步调试和调试寄存器的使用。

 11. 基本的图形操作接口。窗口控件、矩形、圆、点、线的绘制填充等简单图像化接口。支持类似于windows的图形化窗口显示。
 12. 类似于windows的控制台程序。

 13. 浮点中断的简单处理。主要用于数学计算。
 
 14. elf文件和pe文件的加载执行。关于这部分，网上资料也很多，可自行百度。
 15. 一些较为复杂的图形、动画等。包括三体动画、自由落体小球、数字时钟显示、图形化钟表程序、汉语诗词动态显示、多种数学曲线的动画演示等。
